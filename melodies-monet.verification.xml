<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!-- SLURM submission info-->
<!ENTITY ACCOUNT "wrf-chem"> 
<!ENTITY QUEUE "batch">

<!ENTITY PARTITION "hera">
<!ENTITY PARTITION_SEND "service">
<!ENTITY PARTITION_MEDMEM "hera">
<!ENTITY PARTITION_BIGMEM "bigmem">

<!ENTITY RESERVATION '<partition>&PARTITION;</partition><queue>&QUEUE;</queue><account>&ACCOUNT;</account>'>
<!ENTITY RESERVATION_SEND '<native>--mail-type=NONE</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION_SEND;</partition>'>
<!ENTITY RESERVATION_MEDMEM '<native>--mail-type=NONE</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION_MEDMEM;</partition>'>
<!ENTITY RESERVATION_BIGMEM '<native>--mail-type=NONE</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION_BIGMEM;</partition>'>

<!ENTITY JOIN_RESOURCES_LONG "<walltime>12:00:00</walltime><memory>20G</memory>">
<!ENTITY JOIN_RESOURCES "<walltime>08:00:00</walltime><memory>20G</memory>">
<!ENTITY JOIN_RESOURCES_SHORT "<walltime>04:00:00</walltime><memory>40G</memory>">
<!ENTITY JOIN_RESOURCES_SHORTER "<walltime>02:00:00</walltime><memory>20G</memory>">
<!ENTITY JOIN_RESOURCES_SHORTEST "<walltime>01:00:00</walltime><memory>80G</memory>">
<!ENTITY JOIN_RESOURCES_MEDMEM "<walltime>03:00:00</walltime><memory>64G</memory>">
<!ENTITY JOIN_RESOURCES_BIGMEM "<walltime>07:00:00</walltime><memory>80G</memory>">
<!ENTITY JOIN_PROC "1">

<!ENTITY LOG_DIR "&MELODIES_MONET_DIR;/logs">
<!ENTITY PLOTDIR "&MELODIES_MONET_DIR;/plot_output/">
<!ENTITY SCRIPTS_DIR "/home/Jordan.Schnell/scripts/rrfs-sd_verification">


<!-- EDIT THESE ENTITIES FOR YOU EXPERIMENT --> 
<!ENTITY MELODIES_MONET_DIR "/scratch1/BMC/wrf-chem/Jordan/melodies_monet_offline">
<!ENTITY START_ANALYSIS_TIME_YYYYMMDD "20230507">
<!ENTITY END_ANALYSIS_TIME_YYYYMMDD "20230510">
<!ENTITY STMPLIST "/scratch1/BMC/wrf-chem/Jordan/RRFS-SD/scripts/PP/NA_ebb2_test/stmp_list.txt">
<!ENTITY NAMELIST "/scratch1/BMC/wrf-chem/Jordan/RRFS-SD/scripts/PP/NA_ebb2_test/monet_namelist">

]>

<workflow realtime="F" scheduler="slurm" cyclethrottle="999" cyclelifespan="99999:00:00:00" taskthrottle="40">

  <log>
    <cyclestr>&LOG_DIR;/workflow_melodies-monet.@Y@m@d@H.log</cyclestr>
  </log>
  <cycledef group="basehr">00 00 07 05 2023 *</cycledef>
  <cycledef group="00hr">00 00 07-10 05 2023 *</cycledef>

  <metatask name="prepare_rrfs-sd_output">
  <var name="frame">1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</var>    
   <task name="prepare_rrfs-sd_output_#frame#" cycledefs="00hr" maxtries="1">
      &JOIN_RESOURCES_SHORTEST;
      &RESERVATION_BIGMEM;
      <command>&SCRIPTS_DIR;/format_rrfs-sd_files_for_monet.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>format_rrfs-sd_@Y@m@d@H_#frame#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/format_rrfs-sd_@Y@m@d@H_#frame#.log</cyclestr></join>
      <envar>
        <name>STMP_LIST</name>
        <value>&STMPLIST;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d</cyclestr></value>
      </envar>
      <envar>
        <name>cycleHH</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>FRAME</name>
        <value>#frame#</value>
      </envar>
    </task>
  </metatask>
  
  <metatask name="prepare_rrfs-sd_output_phyf">
  <var name="frame">1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</var>    
   <task name="prepare_rrfs-sd_output_phyf_#frame#" cycledefs="00hr" maxtries="1">
      &JOIN_RESOURCES_SHORTEST;
      &RESERVATION_BIGMEM;
      <command>&SCRIPTS_DIR;/format_rrfs-sd_files_for_PP.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>format_rrfs-sd_@Y@m@d@H_phyf_#frame#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/format_rrfs-sd_@Y@m@d@H_phyf_#frame#.log</cyclestr></join>
      <envar>
        <name>STMP_LIST</name>
        <value>&STMPLIST;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d</cyclestr></value>
      </envar>
      <envar>
        <name>cycleHH</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>FRAME</name>
        <value>#frame#</value>
      </envar>
    </task>
  </metatask>


 <metatask name="run_pp">
  <var name="diag">PBL_DIAG</var>
  <metatask>
  <var name="frame">1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</var>
    <task name="run_pp_#diag#_#frame#" cycledefs="00hr" maxtries="1">
      &JOIN_RESOURCES_SHORTEST;
      &RESERVATION_BIGMEM;
      <command>&SCRIPTS_DIR;/run_pp.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>mm_run_pp_offline_@Y@m@d@H_#diag#_#frame#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/mm_run_pp_offline_@Y@m@d@H_#diag#_#frame#.log</cyclestr></join>
      <envar>
        <name>VAR_PKG_2PLOT</name>
        <value>#diag#</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value>&START_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>END_TIME</name>
        <value>&END_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>SCRIPTS_DIR</name>
        <value>&SCRIPTS_DIR;</value>
      </envar>
      <envar>
        <name>cycleHH</name>
        <value><cyclestr>@H</cyclestr></value>
      </envar>
      <envar>
        <name>STMP_LIST</name>
        <value>&STMPLIST;</value>
      </envar>
      <envar>
        <name>FRAME</name>
        <value>#frame#</value>
      </envar>
      <envar>
        <name>WORKDIR</name>
        <value><cyclestr>&MELODIES_MONET_DIR;/@Y@m@d@H/</cyclestr></value>
      </envar>
      <dependency>
        <metataskdep metatask="prepare_rrfs-sd_output_phyf"/>
      </dependency>
    </task>
   </metatask>
  </metatask>


  
  <metatask name="mm_get_obs">
    <var name="obstype">AIRNOW AERONET ISH ISH-LITE HMS</var>
    <task name="mm_get_obs_#obstype#" cycledefs="basehr" maxtries="1">
      &JOIN_RESOURCES_SHORT;
      &RESERVATION_SEND;
      <command>&SCRIPTS_DIR;/mm_get_obs.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>mm_get_obs_offline_@Y@m@d@H_#obstype#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/mm_get_obs_offline_@Y@m@d@H_#obstype#.log</cyclestr></join>
      <envar>
        <name>OBSTYPE</name>
        <value>#obstype#</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value>&START_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>END_TIME</name>
        <value>&END_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>SCRIPTS_DIR</name>
        <value>&SCRIPTS_DIR;</value>
      </envar>
      <envar>
        <name>WORKDIR</name>
        <value><cyclestr>&MELODIES_MONET_DIR;/@Y@m@d@H/</cyclestr></value>
      </envar>
    </task>
  </metatask>

  <metatask name="mm_run_noaa">
    <var name="species">PM25 PM10 TEMP AOD550 temp dew_pt_temp wdir ws precip_1hr vsb ceiling</var>
    <task name="mm_run_noaa_#species#" cycledefs="basehr" maxtries="1">
      &JOIN_RESOURCES_MEDMEM;
      &RESERVATION_MEDMEM;
      <command>&SCRIPTS_DIR;/mm_run.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>mm_run-noaa_@Y@m@d@H_#species#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/mm_run-noaa_@Y@m@d@H_#species#.log</cyclestr></join>
      <envar>
        <name>WORKDIR</name>
        <value><cyclestr>&MELODIES_MONET_DIR;/@Y@m@d@H/#species#</cyclestr></value>
      </envar>
      <envar>
        <name>PLOT_OUTPUT_DIR</name>
        <value>&PLOTDIR;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value>&START_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>END_TIME</name>
        <value>&END_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>SCRIPTS_DIR</name>
        <value>&SCRIPTS_DIR;</value>
      </envar>
      <envar>
        <name>SPECIES_TO_VERIFY</name>
        <value>#species#</value>
      </envar>
      <envar>
        <name>namelist</name>
        <value>&NAMELIST;</value>
      </envar>
      <dependency>
       <and>
         <taskdep state="Succeeded" task="mm_get_obs_AIRNOW"/>
         <metataskdep state="Succeeded" metatask="prepare_rrfs-sd_output"/>
         <or>
          <taskdep state="Succeeded" task="mm_get_obs_AERONET"/>
          <taskdep state="Dead" task="mm_get_obs_AERONET"/>
         </or>
         <or>
          <taskdep state="Succeeded" task="mm_get_obs_ISH"/>
          <taskdep state="Dead" task="mm_get_obs_ISH"/>
         </or>
         <or>
          <taskdep state="Succeeded" task="mm_get_obs_ISH-LITE"/>
          <taskdep state="Dead" task="mm_get_obs_ISH-LITE"/>
         </or>
         <or>
          <taskdep state="Succeeded" task="mm_get_obs_HMS"/>
          <taskdep state="Dead" task="mm_get_obs_HMS"/>
         </or>
       </and>
      </dependency>
    </task>
  </metatask>

    <task name="mm_folium_noaa" cycledefs="basehr" maxtries="1">
      &JOIN_RESOURCES_SHORT;
      &RESERVATION;
      <command>&SCRIPTS_DIR;/mm_folium.sh</command>
      <cores>&JOIN_PROC;</cores>
      <jobname><cyclestr>mm_folium-noaa_@Y@m@d@H</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/mm_folium-noaa_@Y@m@d@H.log</cyclestr></join>
      <envar>
        <name>WORKDIR</name>
        <value><cyclestr>&MELODIES_MONET_DIR;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>PLOT_OUTPUT_DIR</name>
        <value>&PLOTDIR;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value>&START_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>END_TIME</name>
        <value>&END_ANALYSIS_TIME_YYYYMMDD;</value>
      </envar>
      <envar>
        <name>SCRIPTS_DIR</name>
        <value>&SCRIPTS_DIR;</value>
      </envar>
      <dependency>
       <and>
         <or>
          <taskdep state="Succeeded" task="mm_run_noaa_PM25"/>
          <taskdep state="Dead" task="mm_run_noaa_PM25"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_TEMP"/>
          <taskdep state="Dead" task="mm_run_noaa_TEMP"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_AOD550"/>
          <taskdep state="Dead" task="mm_run_noaa_AOD550"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_PM10"/>
          <taskdep state="Dead" task="mm_run_noaa_PM10"/>
        </or>
         <or>
          <taskdep state="Succeeded" task="mm_run_noaa_temp"/>
          <taskdep state="Dead" task="mm_run_noaa_temp"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_dew_pt_temp"/>
          <taskdep state="Dead" task="mm_run_noaa_dew_pt_temp"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_ws"/>
          <taskdep state="Dead" task="mm_run_noaa_ws"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_wdir"/>
          <taskdep state="Dead" task="mm_run_noaa_wdir"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_precip_1hr"/>
          <taskdep state="Dead" task="mm_run_noaa_precip_1hr"/>
        </or>
        <or>
          <taskdep state="Succeeded" task="mm_run_noaa_vsb"/>
          <taskdep state="Dead" task="mm_run_noaa_vsb"/>
        </or>
       </and>
      </dependency>
    </task>
</workflow> 
